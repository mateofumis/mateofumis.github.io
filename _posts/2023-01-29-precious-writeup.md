---
title:  "Writeup de la m치quina Precious de Hack The Box"
date: 2023-01-29
mathjax: true
layout: post
categories: writeup
tags: ruby exiftool metadata xss exploit CVE
---

# Resoluci칩n de la m치quina Precious de la plataforma de HackTheBox

![](https://i.ibb.co/zSN39h5/precious.png)

### 游눑 *"Ruby developers will love this machine"*

**Como primer paso vamos a comprobar que nuestra m치quina como atacante tiene conexi칩n con la m치quina v칤ctima que vamos a vulnerar. Esto lo conseguimos envi치ndole una traza ICMP con el comando ping:**

```bash
ping -c1 10.10.11.189
```

**Con el comando anterior sabemos que adem치s de tener conexi칩n, lo m치s probable es que la m치quina victima est칠 ejecutando un sistema operativo Linux por resultado del "ttl" (time to live) el cual est치 m치s cercano a "64"**

![](https://i.ibb.co/1bDVJmq/ping-screenshot.png)

**Ahora s칤, vamos con el reconocimiento, y para eso escaneamos los puertos de la m치quina con Nmap de la siguiente manera:**

```bash
sudo nmap 10.10.11.189 -vvv -Pn -p- --min-rate 5000 --open -sS -oG openPorts
```

Con el comando anterior exportamos el resultado en un formato en el cual podamos extraer los puertos abiertos con la ayuda del comando *"grep"* y luego escanear en profundidad con el siguiente comando:

```bash
sudo nmap 10.10.11.189 -p22,80 -sVC -Pn -vvv -oN scanComplete
```

#### Ahora con el escaneo completo obtenemos el siguiente resultado:

![](https://i.ibb.co/X7sHv8x/nmap-scan-Complete.png)

**Como est치 abierto el puerto 80 corriendo el servicio http, entramos en el navegador web en la direcci칩n IP de la m치quina por ese puerto:**

![](https://i.ibb.co/WtMm0Wn/redirecci-n-http-dominio.png)

En ese momento se nos redirecciona a "precious.htb" como se ve en la imagen de arriba, por lo tanto a침adimos el dominio "precious.htb" al archivo /etc/hosts. Esto es necesario para que luego mediante avance el pentesting no tengamos problemas al realizar la resoluci칩n de DNS de la direcci칩n IP y directamente nos redirija a el dominio correcto.

![](https://i.ibb.co/mbZ2vkf/etc-hosts.png)

**Al intentar cargarle una direcci칩n URL como https://www.google.com o la propia direccion de la m치quina v칤ctima, nos dice que no puede cargar direcciones remotas, pero si intentamos escribir el protocolo ""http://" seguido de un script simple de XSS, la aplicaci칩n web nos la acepta.**

![](https://i.ibb.co/b5NwBgh/intento-url.jpg)

Cuando se nos genera el PDF aparentemente est치 vac칤o, pero lo podemos descargar y analizar los metadatos, para eso utilizamos la herramienta "exiftool" y vemos los siguientes metadatos:

![](https://i.ibb.co/c8GWYg6/exiftool-metadata.png)

**Por lo que vemos, la m치quina victima con su aplicaci칩n web del lado del Backend nos est치 generando un PDF, al parecer con "pdfkit" en su versi칩n 0.8.6 "Generated by pdfkit v0.8.6"**

Para esto podemos googlear alguna vulnerabilidad o exploit con las palabras claves de "pdfkit v0.8.6". Luego de buscar, encontr칠 en Github un exploit para esta versi칩n de "pdfkit". Enlace: [https://github.com/CyberArchitect1/CVE-2022-25765-pdfkit-Exploit-Reverse-Shell](https://github.com/CyberArchitect1/CVE-2022-25765-pdfkit-Exploit-Reverse-Shell){:target="_blank"}

**Para usar el exploit, debemos ejecutar el siguiente comando con nuestra propia direcci칩n IP, pero antes hay que poner Netcat a la escucha en el puerto que elijamos y levantar un servidor http (en mi caso en el puerto 80):**

![](https://i.ibb.co/RN6gbVt/ejecuci-n-del-exploit.png)

**Y lo logramos! Obtuvimos una shell reversa como el usuario "ruby". Ahora solo queda escalar privilegios y obtener las flags de usuario y de root.**

Luego de revisar los arhivos, encontramos uno interesante que contiene la contrase침a del otro usuario "henry":

![](https://i.ibb.co/R3MMSTq/contrase-a-de-usuario-henry-encontrada.png)

**Como recordamos que tenemos el puerto 22 con el servicio SSH abierto, nos conectamos a la m치quina como el usuario "henry" y la contrase침a "Q3c1AqGHtoI0aXAYFH":**

![](https://i.ibb.co/gV2ZkTL/conexi-n-ssh.png)

Primeramente ejecutamos el comando:

```bash
sudo -l
```

Con el fin de saber qu칠 podemos ejecutar como el usuario "henry" pero con privilegios de root, por lo que vemos, tenemos acceso al binario ruby en /usr/bin/ruby y al archivo "update_dependencies.rb" en la carpeta /opt.

![](https://i.ibb.co/KDncyCc/permisos-de-henry-con-sudo-L.png)

Primero obtenemos la flag de usuario en /home/henry/user.txt

![](https://i.ibb.co/kQz5NX1/flag-user.png)

**Luego de revisar los archivos, podemos intentar abusarnos del archivo "update_dependencies" y ejecutar como root el binario /usr/bin/ruby de forma que modificamos el archivo "dependencies.yml":**

![](https://i.ibb.co/hFCfDh7/modificar-archivo.png)

Esto funciona gracias a que el archivo "update_dependencies" est치 ejecutando con ruby con privilegios de root el archivo dependencies.yml en el directorio /home/henry y al modificarlo es tan sencillo como ejecutar cambiar el permiso de /usr/bin/bash para luego ejecutar:

```bash
/usr/bin/bash -p
```

![](https://i.ibb.co/w02Zffc/flag-root.png)

#### Y con esto logramos obtener la flag de root y conseguimos acceso total de la m치quina!

Happy Hacking!!

----

## Author: Mateo Fumis 
